---
title: "Jean's simulation"
author: "Jean Fan"
date: "2/22/2023"
output:
  pdf_document: default
  html_document: default
---

```{r}
############# make new simulation
#library(ggplot2)

## cells
set.seed(1)
size <- 1000
x <- runif(size, min = 0, max = 10000)
y <- runif(size, min = 0, max = 10000)
p <- data.frame(x = x, y = y, type='D')
rownames(p) <- paste0('cell', 1:size)
head(p)
#ggplot(p, aes(x=x, y=y)) + geom_point(size=0.5) 

## structures
set.seed(10)
N <- 5 
as <- sample(x, N)
bs <- sample(y, N)
invisible(sapply(1:N, function(i) {
  a <- as[i]
  b <- bs[i]
  ro <- 1000
  co <- 'A'
  po <- 1
  c1o <- rownames(p[((p$x-a)^2 + (p$y - b)^2 < ro^2),])
  p[c1o,]$type <<- sample(co, size = length(c1o), replace = TRUE, prob = po)
}))
#ggplot(p, aes(x=x, y=y,col=type)) + geom_point(size=0.5) 

invisible(sapply(1:N, function(i) {
  ro <- 500
  co <- 'B'
  po <- 1
  
  ## inside structure
  a <- as[i]
  b <- bs[i]
  c1o <- rownames(p[((p$x-a)^2 + (p$y - b)^2 < ro^2),])
  p[c1o,]$type <<- sample(co, size = length(c1o), replace = TRUE, prob = po)
}))

set.seed(1000)
M <- N*2
as2 <- sample(x, M)
bs2 <- sample(y, M)

invisible(sapply(1:M, function(i) {
  ro <- 500
  co <- 'B'
  po <- 1
  ## outside structure
  a <- as2[i]
  b <- bs2[i]
  c1o <- rownames(p[((p$x-a)^2 + (p$y - b)^2 < ro^2),])
  p[c1o,]$type <<- sample(co, size = length(c1o), replace = TRUE, prob = po)
}))
#ggplot(p, aes(x=x, y=y,col=type)) + geom_point(size=0.5) 

invisible(sapply(1:N, function(i) {
  ro <- 400
  co <- 'C'
  po <- 1
  
  ## inside structure
  a <- as[i]
  b <- bs[i]
  c1o <- rownames(p[((p$x-a)^2 + (p$y - b)^2 < ro^2),])
  p[c1o,]$type <<- sample(co, size = length(c1o), replace = TRUE, prob = po)
}))
#ggplot(p, aes(x=x, y=y,col=type)) + geom_point(size=0.5)

set.seed(10000)
as3 <- sample(x, M)
bs3 <- sample(y, M)
invisible(sapply(1:M, function(i) {
  ro <- 500
  co <- 'C'
  po <- 1
  ## outside structure
  a <- as3[i]
  b <- bs3[i]
  c1o <- rownames(p[((p$x-a)^2 + (p$y - b)^2 < ro^2),])
  p[c1o,]$type <<- sample(co, size = length(c1o), replace = TRUE, prob = po)
}))
#ggplot(p, aes(x=x, y=y,col=type)) + geom_point(size=0.5) 
```
Actually using `crawdad`

## load library
```{r}
library(crawdad)
```

```{r}
## convert to SP
cells <- crawdad:::toSP(pos = p[,c("x", "y")],
                        celltypes = p$type)
plot(cells, pch=16)
```

```{r}
## generate background
shuffle.list <- crawdad:::makeShuffledCells(cells,
                        resolutions = c(250, 500, 1000, 3000, 5000, 10000),
                        perms = 1,
                        ncores = 10,
                        seed = 1,
                        verbose = FALSE)
```


## run pairwise
```{r}
## find trends, passing background as parameter
results <- crawdad::findTrends(cells,
                        dist = 250,
                        sub.type = "pairwise",
                        shuffle.list = shuffle.list,
                        perms = 1,
                        ncores = 10,
                        seed = 1, 
                        verbose = FALSE)
```

## plot
```{r}
## give users option to save
#crawdad::plotTrends(results = results, idcol = "dist")
crawdad::plotTrends(results = results[1], idcol = "dist")
```

```{r}
##### get subsets
## note I can choose to save the output
## or I should be able to just pass subset.list as a parameter
## rather than forcing me to save and load from a file
##### also currently not exported so using :::
subset.list <- crawdad:::getSubsets(cells = cells,
                          sub.dist = 250,
                          sub.type = "near",
                          sub.thresh = 0.05,
                          ncores = 10,
                          verbose = FALSE)
```

```{r}
## bit confusing that findTrends for pairs and triplets are same
## what happens if you use the wrong sub.type parameter?
## anticipate user error
results2 <- crawdad::findTrends(cells,
                        dist = 250,
                        sub.type = "near",
                        shuffle.list = shuffle.list,
                        subset.list = subset.list,
                        perms = 1,
                        ncores = 10,
                        seed = 1, 
                        verbose = FALSE)
```

```{r}
## issue has Nans because some cells not ever found near each other
## ideally should be ignored when plotting
## currently hack fix by setting to 0
results2.fixed <- lapply(results2, function(x) {
  x[is.nan(x)] <- 0
  return(x)
})

## plot just some
crawdad::plotTrends(results = results2.fixed[11], idcol = "dist")
```


