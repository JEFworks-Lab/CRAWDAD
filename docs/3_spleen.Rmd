---
title: "CODEX Spleen Analysis"
author: 
- "Rafael dos Santos Peixoto"
- "Brendan F. Miller"
date: "10/03/2023"
# output: rmarkdown::html_document
output:
  md_document:
    variant: markdown_github
vignette: >
  %\VignetteIndexEntry{CODEX spleen analysis}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

This vignette will go through analyses to reproduce the results and figures of the CODEX spleen datasets.

```{r}

library(crawdad)
library(tidyverse)

```

```{r}

ncores = 7

```

# PKHL Sample

## Load data

```{r, warning=FALSE}

data(pkhl)

## convert to sp::SpatialPointsDataFrame
pkhl <- crawdad:::toSP(pos = pkhl[,c("x", "y")],
                       celltypes = pkhl$celltypes)

```

## Visualize celltypes

```{r celltypes, warning=FALSE, message=FALSE, fig.height=24, fig.width=24}

crawdad::vizEachCluster(cells = pkhl,
                        coms = as.factor(pkhl$celltypes),
                        s = 2)

```

## Make shuffled background

```{r}

scales <- seq(100, 1000, by=100)

```

```{r, warning=FALSE}

## generate background
shuffle.list <- crawdad:::makeShuffledCells(pkhl,
                          scales = scales,
                          perms = 3,
                          ncores = ncores,
                          seed = 1,
                          verbose = FALSE)

```

## Run pairwise analysis

```{r, warning=FALSE}

## find trends, passing background as parameter
results <- crawdad::findTrends(pkhl,
                        dist = 100,
                        shuffle.list = shuffle.list,
                        ncores = ncores,
                        verbose = FALSE,
                        returnMeans = FALSE)

```

```{r}

## convert results to data.frame
dat <- crawdad::meltResultsList(results, withPerms = T)

```

## Visualize results

```{r}

## multiple-test correction
ntests <- length(unique(dat$reference)) * length(unique(dat$reference))
psig <- 0.05/ntests
zsig <- round(qnorm(psig/2, lower.tail = F), 2)

```

Summary visualization of CRAWDADâ€™s multi-scale cell-type spatial relationship analysis.

```{r colocalization, fig.height=9, fig.width=11}

vizColocDotplot(dat, reorder = TRUE, zsig.thresh = zsig, zscore.limit = zsig*2) +
  theme(legend.position='right',
        axis.text.x = element_text(angle = 45, h = 0))

```

## Defining subsets

```{r, warning=FALSE}

binomMat <- crawdad::binomialTestMatrix(pkhl,
                                        neigh.dist = 100,
                                        ncores = ncores,
                                        verbose = TRUE)

```

## Select subsets

```{r, warning=FALSE}

subset.list <- crawdad::selectSubsets(binomMat,
                                      pkhl$celltypes,
                                      sub.type = "near",
                                      sub.thresh = 0.05,
                                      ncores = ncores,
                                      verbose = TRUE)

```

## Run analysis on subsets

```{r, warning=FALSE}

results.subsets <- crawdad::findTrends(pkhl,
                                       dist = 100,
                                       shuffle.list = shuffle.list,
                                       subset.list = subset.list,
                                       ncores = ncores,
                                       verbose = TRUE,
                                       returnMeans = FALSE)

```

```{r}

## convert results to data.frame
dats <- crawdad::meltResultsList(results.subsets, withPerms = TRUE)

```

## Visualize subset results

```{r}

## multiple-test correction for the number of subsets
ntestss <- length(unique(dats$reference)) * length(unique(dats$neighbor))
psigs <- 0.05/ntestss
zsigs <- round(qnorm(psigs/2, lower.tail = F), 2)

```

Visualize specific subset trends.

```{r pkhl_subset_trend, warning=FALSE}

dats %>% 
  filter(neighbor == 'Podoplanin') %>% 
  filter(reference == 'CD4 Memory T cells_near_Fol B cells') %>% 
  vizTrends(lines = T, withPerms = T, sig.thresh = zsigs)

```

Visualize cell-type proportions.

```{r}

ct_ngb <- 'CD4 Memory T cells' ## neighbor cell type
ct_ref <- 'Fol B cells' ## reference cell type
df <- pkhl
sample <- 'pkhl'

## select cells from each subset
c_ctn_near <- subset.list[[paste(ct_ngb, 'near', ct_ref, sep = '_')]]
c_ctn <- which(df$celltypes == ct_ngb)
c_ctn_notnear <- c_ctn[!c_ctn %in% c_ctn_near]
c_ctr <- which(df$celltypes == ct_ref)

## create data.frame of cell counts in each cell type
df_freq_ct <- as.data.frame(table(df$celltypes))
colnames(df_freq_ct) <- c('celltypes', 'frequency')
df_freq_sub <- data.frame(celltypes = c(paste(ct_ngb, 'near', ct_ref),
                                        paste(ct_ngb, 'not near', ct_ref)),
                          frequency = c(length(c_ctn_near),
                                        length(c_ctn_notnear)))
df_freq <- rbind(df_freq_ct, df_freq_sub)
df_freq$sample <- sample_name

## barplot
df_freq %>% 
  filter(grepl(paste0(ct_ref, '$'), celltypes)) %>% 
  ggplot(aes(x = sample, y = frequency, fill = celltypes)) +
  geom_bar(stat = "identity", position = "dodge") 

```


# KSFB Sample

## Load data

```{r, eval=TRUE}

ksfb <- read.csv2(file = paste0(here::here(), "/data/spleen/KSFB.meta.csv.gz"), row.names = 1)
ksfb <- ksfb[,c("x", "y", "celltypes_folBcombined")]
## make sure the coordinates are numeric
ksfb <- ksfb %>%
  dplyr::mutate_at(vars(x, y), as.numeric)

## convert to SP
ksfb <- crawdad::toSP(pos = ksfb[,c("x", "y")],
                        celltypes = ksfb$celltypes_folBcombined)
ksfb

```


# XXCD Sample

## Load data

```{r, eval=TRUE}

xxcd <- read.csv2(file = paste0(here::here(), "/data/spleen/XXCD.meta.csv.gz"), row.names = 1)
xxcd <- xxcd[,c("x", "y", "celltypes_folBcombined")]
## make sure the coordinates are numeric
xxcd <- xxcd %>%
  dplyr::mutate_at(vars(x, y), as.numeric)

## convert to SP
xxcd <- crawdad::toSP(pos = xxcd[,c("x", "y")],
                        celltypes = xxcd$celltypes_folBcombined)
xxcd

```

# PBVN Sample

## Load data

```{r, eval=TRUE}

pbvn <- read.csv2(file = paste0(here::here(), "/data/spleen/PBVN.meta.csv.gz"), row.names = 1)
pbvn <- pbvn[,c("x", "y", "celltypes_folBcombined")]
## make sure the coordinates are numeric
pbvn <- pbvn %>%
  dplyr::mutate_at(vars(x, y), as.numeric)

## convert to SP
pbvn <- crawdad::toSP(pos = pbvn[,c("x", "y")],
                        celltypes = pbvn$celltypes_folBcombined)
pbvn

```

# FSLD Sample

## Load data

```{r, eval=TRUE}

fsld <- read.csv2(file = paste0(here::here(), "/data/spleen/FSLD.meta.csv.gz"), row.names = 1)
fsld <- fsld[,c("x", "y", "celltypes_folBcombined")]
## make sure the coordinates are numeric
fsld <- fsld %>%
  dplyr::mutate_at(vars(x, y), as.numeric)

## convert to SP
fsld <- crawdad::toSP(pos = fsld[,c("x", "y")],
                        celltypes = fsld$celltypes_folBcombined)
fsld

```

# NGPL Sample

## Load data

```{r, eval=TRUE}

ngpl <- read.csv2(file = paste0(here::here(), "/data/spleen/NGPL.meta.csv.gz"), row.names = 1)
ngpl <- ngpl[,c("x", "y", "celltypes_folBcombined")]
## make sure the coordinates are numeric
ngpl <- ngpl %>%
  dplyr::mutate_at(vars(x, y), as.numeric)

## convert to SP
ngpl <- crawdad::toSP(pos = ngpl[,c("x", "y")],
                        celltypes = ngpl$celltypes_folBcombined)
ngpl

```

